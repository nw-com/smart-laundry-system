<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>經營者後台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 引入 SortableJS 用於拖曳排序 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
        .main-layout { display: flex; flex-direction: column; height: 100vh; }
        .main-content { flex-grow: 1; overflow: hidden; }
        .scrollable-area { overflow-y: auto; height: 100%; }
        .sidebar-link.active { @apply bg-red-100 text-red-700; }
        .content-panel { display: none; }
        .content-panel.active { display: block; }
        .modal { display: none; }
        .modal.flex { display: flex; }
        .sortable-ghost {
            background: #f0f0f0;
            opacity: 0.6;
        }
        .sortable-header {
            cursor: pointer;
            user-select: none;
        }
         .sortable-header .sort-icon {
            opacity: 0.3;
        }
        .sortable-header.sort-asc .fa-sort-up,
        .sortable-header.sort-desc .fa-sort-down {
            opacity: 1;
            color: #ef4444; /* red-500 */
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="main-layout">
        <!-- Header -->
        <header class="bg-white shadow-md p-4 flex justify-between items-center flex-shrink-0 z-10">
            <h1 class="text-xl font-bold text-gray-800"><i class="fas fa-user-tie mr-3 text-red-500"></i>經營者後台</h1>
            <div>
                <span id="user-display" class="text-gray-600 mr-4">歡迎, 載入中...</span>
                <a href="./index.html" class="text-red-500 hover:text-red-700"><i class="fas fa-sign-out-alt mr-1"></i>登出</a>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content flex">
            <!-- Sidebar -->
            <nav class="w-64 bg-white p-4 flex-shrink-0">
                <ul class="space-y-2">
                    <li><a href="#" class="sidebar-link flex items-center p-2 text-base font-normal text-gray-900 rounded-lg active" data-target="dashboard"><i class="fas fa-tachometer-alt w-6"></i><span class="ml-3">總覽</span></a></li>
                    <li><a href="#" class="sidebar-link flex items-center p-2 text-base font-normal text-gray-900 rounded-lg hover:bg-gray-100" data-target="accounts"><i class="fas fa-id-card w-6"></i><span class="ml-3">帳號管理</span></a></li>
                    <li><a href="#" class="sidebar-link flex items-center p-2 text-base font-normal text-gray-900 rounded-lg hover:bg-gray-100" data-target="stores"><i class="fas fa-store w-6"></i><span class="ml-3">門市管理</span></a></li>
                    <li><a href="#" class="sidebar-link flex items-center p-2 text-base font-normal text-gray-900 rounded-lg hover:bg-gray-100" data-target="factories"><i class="fas fa-industry w-6"></i><span class="ml-3">工廠管理</span></a></li>
                    <li><a href="#" class="sidebar-link flex items-center p-2 text-base font-normal text-gray-900 rounded-lg hover:bg-gray-100" data-target="reports"><i class="fas fa-chart-line w-6"></i><span class="ml-3">營運報表</span></a></li>
                    <li><a href="#" class="sidebar-link flex items-center p-2 text-base font-normal text-gray-900 rounded-lg hover:bg-gray-100" data-target="customers"><i class="fas fa-users w-6"></i><span class="ml-3">顧客管理</span></a></li>
                    <li><a href="#" class="sidebar-link flex items-center p-2 text-base font-normal text-gray-900 rounded-lg hover:bg-gray-100" data-target="settings"><i class="fas fa-cog w-6"></i><span class="ml-3">系統設定</span></a></li>
                </ul>
            </nav>
            
            <!-- Scrollable Content Area -->
            <div class="flex-grow scrollable-area p-6">
                <!-- Dashboard Content -->
                <main id="dashboard" class="content-panel active">
                    <h2 class="text-2xl font-bold mb-6">總覽</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow"><h3 class="text-gray-500">今日營收</h3><p class="text-3xl font-bold text-red-600">NT$ 12,345</p></div>
                        <div class="bg-white p-6 rounded-lg shadow"><h3 class="text-gray-500">今日訂單數</h3><p class="text-3xl font-bold">128</p></div>
                        <div class="bg-white p-6 rounded-lg shadow"><h3 class="text-gray-500">活躍門市</h3><p class="text-3xl font-bold">5 / 5</p></div>
                        <div class="bg-white p-6 rounded-lg shadow"><h3 class="text-gray-500">待處理衣物</h3><p class="text-3xl font-bold">342 件</p></div>
                    </div>
                </main>

                <!-- Account Management Content -->
                <main id="accounts" class="content-panel">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">帳號管理</h2>
                        <button id="add-account-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">
                            <i class="fas fa-plus mr-2"></i>新增帳號
                        </button>
                    </div>
                    <div class="bg-white rounded-lg shadow overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-4 whitespace-nowrap sortable-header" data-sort="name">
                                        姓名 <span class="sort-icon"><i class="fas fa-sort-up"></i><i class="fas fa-sort-down"></i></span>
                                    </th>
                                    <th class="p-4 whitespace-nowrap sortable-header" data-sort="email">
                                        電子郵件 <span class="sort-icon"><i class="fas fa-sort-up"></i><i class="fas fa-sort-down"></i></span>
                                    </th>
                                    <th class="p-4 whitespace-nowrap">角色</th>
                                    <th class="p-4 whitespace-nowrap">職稱</th>
                                    <th class="p-4 whitespace-nowrap">操作</th>
                                </tr>
                            </thead>
                            <tbody id="user-list-body">
                                <!-- User rows will be injected here by JS -->
                            </tbody>
                        </table>
                    </div>
                </main>
                
                <main id="stores" class="content-panel"><h2 class="text-2xl font-bold mb-6">門市管理</h2></main>
                <main id="factories" class="content-panel"><h2 class="text-2xl font-bold mb-6">工廠管理</h2></main>
                <main id="reports" class="content-panel"><h2 class="text-2xl font-bold mb-6">營運報表</h2></main>
                <main id="customers" class="content-panel"><h2 class="text-2xl font-bold mb-6">顧客管理</h2></main>
                
                <!-- System Settings Content -->
                <main id="settings" class="content-panel">
                    <h2 class="text-2xl font-bold mb-6">系統設定</h2>
                    <div class="bg-white p-8 rounded-lg shadow-md max-w-2xl mx-auto">
                        <h3 class="text-xl font-semibold mb-6 border-b pb-4">職稱管理</h3>
                        <div class="space-y-4">
                            <div class="flex space-x-2">
                                <input id="new-title-input" type="text" placeholder="輸入新的職稱" class="flex-grow p-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500">
                                <button id="add-title-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">新增</button>
                            </div>
                            <ul id="title-list" class="space-y-2 pt-4">
                                <!-- 職稱列表將由 JavaScript 動態生成 -->
                            </ul>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Add/Edit Account Modal (repurposed) -->
    <div id="account-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 id="modal-title" class="text-xl font-semibold">新增登入帳號</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div class="p-8 overflow-y-auto">
                <form id="account-form" class="space-y-6">
                    <input type="hidden" name="uid">
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">角色</label>
                            <select name="role" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500">
                                <option value="">-- 請選擇角色 --</option>
                                <option value="admin">經營者</option>
                                <option value="shop-manager">店家(主管)</option>
                                <option value="shop-staff">店家(員工)</option>
                                <option value="shop-auto">店家(自助)</option>
                                <option value="factory">工廠</option>
                                <option value="customer">顧客</option>
                            </select>
                        </div>
                        <div class="flex items-center space-x-4">
                            <img id="avatar-preview" src="https://placehold.co/100x100/e2e8f0/cbd5e0?text=頭像" alt="Avatar Preview" class="w-24 h-24 rounded-full object-cover bg-gray-200">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">大頭照</label>
                                <input name="avatar" id="avatar-input" type="file" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100"/>
                            </div>
                        </div>
                    </div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">姓名</label>
                            <input name="name" type="text" placeholder="請輸入姓名" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">職稱</label>
                             <select name="title" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500" required>
                                <option value="">-- 請選擇職稱 --</option>
                            </select>
                        </div>
                    </div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">手機號碼</label>
                            <input name="phone" type="tel" placeholder="請輸入手機號碼" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">電子郵件 (登入帳號)</label>
                            <input name="email" type="email" placeholder="請輸入電子郵件" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500" required>
                        </div>
                    </div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">密碼</label>
                            <input name="password" type="password" placeholder="留空表示不變更" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">確認密碼</label>
                            <input name="confirmPassword" type="password" placeholder="留空表示不變更" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500">
                        </div>
                    </div>
                     <p id="account-feedback" class="text-sm text-center h-5 my-2"></p>
                    <div class="text-right pt-4">
                        <button type="submit" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition-colors">儲存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm">
            <div class="p-6 text-center">
                <i class="fas fa-exclamation-triangle text-4xl text-yellow-400 mb-4"></i>
                <h3 id="confirm-title" class="text-lg font-semibold mb-2">確定要刪除嗎？</h3>
                <p id="confirm-text" class="text-sm text-gray-600 mb-6">此操作無法復原。</p>
                <div class="flex justify-center space-x-4">
                    <button id="confirm-cancel-btn" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">取消</button>
                    <button id="confirm-action-btn" class="py-2 px-4 bg-red-600 text-white rounded-lg hover:bg-red-700">確定刪除</button>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, getDocs, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBeyVzpxVW2QEMaPXp3QD-pe81qER0qRgg",
            authDomain: "smart-laundry-system-bef41.firebaseapp.com",
            projectId: "smart-laundry-system-bef41",
            storageBucket: "smart-laundry-system-bef41.appspot.com",
            messagingSenderId: "803873226355",
            appId: "1:803873226355:web:22ccb308ff312d47103406",
            measurementId: "G-FBQ997TMQ3"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        document.addEventListener('DOMContentLoaded', async function() {
            let allUsers = [];
            let currentSort = { column: 'name', direction: 'asc' };
            let jobTitles = [];

            // DOM Elements
            const userDisplay = document.getElementById('user-display');
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            const contentPanels = document.querySelectorAll('.content-panel');
            const accountModal = document.getElementById('account-modal');
            const addAccountBtn = document.getElementById('add-account-btn');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const userListBody = document.getElementById('user-list-body');
            const titleList = document.getElementById('title-list');
            const addTitleBtn = document.getElementById('add-title-btn');
            const newTitleInput = document.getElementById('new-title-input');
            const accountForm = document.getElementById('account-form');
            const feedbackElement = document.getElementById('account-feedback');
            const avatarInput = document.getElementById('avatar-input');
            const avatarPreview = document.getElementById('avatar-preview');
            const modalTitle = document.getElementById('modal-title');
            const confirmationModal = document.getElementById('confirmation-modal');

            // --- FIXED: Variable declarations moved up ---
            const roleMapping = { 'admin': '經營者', 'shop-manager': '店家(主管)', 'shop-staff': '店家(員工)', 'shop-auto': '店家(自助)', 'factory': '工廠', 'customer': '顧客' };
            const settingsDocRef = doc(db, "settings", "jobTitles");


            // --- Initial Setup ---
            const userName = sessionStorage.getItem('userName');
            if (userName) userDisplay.textContent = `歡迎, ${userName}`;
            
            await loadJobTitles();
            await fetchAndRenderUsers();

            // --- Event Listeners ---
            addAccountBtn.addEventListener('click', () => openAccountModal('add'));
            closeModalBtn.addEventListener('click', closeAccountModal);

            sidebarLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetId = this.dataset.target;
                    sidebarLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    contentPanels.forEach(p => p.classList.toggle('active', p.id === targetId));
                    if (targetId === 'accounts') fetchAndRenderUsers();
                });
            });
            
            accountForm.addEventListener('submit', handleAccountFormSubmit);
            avatarInput.addEventListener('change', handleAvatarChange);

            // --- Account List Sorting ---
            document.querySelectorAll('.sortable-header').forEach(header => {
                header.addEventListener('click', () => {
                    const column = header.dataset.sort;
                    if (currentSort.column === column) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.column = column;
                        currentSort.direction = 'asc';
                    }
                    sortAndRenderUsers();
                });
            });

            // --- User Management (CRUD) ---
            async function fetchAndRenderUsers() {
                try {
                    userListBody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">載入中...</td></tr>';
                    const querySnapshot = await getDocs(collection(db, "users"));
                    allUsers = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    sortAndRenderUsers();
                } catch (error) {
                    console.error("Error fetching users: ", error);
                    userListBody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-red-500">無法載入使用者列表。</td></tr>';
                }
            }

            function sortAndRenderUsers() {
                allUsers.sort((a, b) => {
                    const valA = a[currentSort.column] || '';
                    const valB = b[currentSort.column] || '';
                    if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                    if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                    return 0;
                });
                renderUserList();
                updateSortHeaders();
            }
            
            function renderUserList() {
                if (allUsers.length === 0) {
                    userListBody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">目前沒有任何帳號。</td></tr>';
                    return;
                }
                userListBody.innerHTML = '';
                allUsers.forEach(user => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b';
                    tr.innerHTML = `
                        <td class="p-4">${user.name || ''}</td>
                        <td class="p-4">${user.email || ''}</td>
                        <td class="p-4">${roleMapping[user.role] || user.role}</td>
                        <td class="p-4">${user.title || ''}</td>
                        <td class="p-4 space-x-4">
                            <button class="text-gray-400 hover:text-blue-500 edit-btn" data-uid="${user.uid}"><i class="fas fa-edit"></i></button>
                            <button class="text-gray-400 hover:text-red-500 delete-btn" data-uid="${user.uid}" data-name="${user.name}"><i class="fas fa-trash"></i></button>
                        </td>`;
                    userListBody.appendChild(tr);
                });
            }
            
            userListBody.addEventListener('click', e => {
                const editBtn = e.target.closest('.edit-btn');
                const deleteBtn = e.target.closest('.delete-btn');
                if (editBtn) openAccountModal('edit', editBtn.dataset.uid);
                if (deleteBtn) handleDeleteUser(deleteBtn.dataset.uid, deleteBtn.dataset.name);
            });

            function updateSortHeaders() {
                document.querySelectorAll('.sortable-header').forEach(header => {
                    header.classList.remove('sort-asc', 'sort-desc');
                    if (header.dataset.sort === currentSort.column) {
                        header.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                    }
                });
            }
            
            // --- Account Modal & Form ---
            async function openAccountModal(mode, uid = null) {
                accountForm.reset();
                resetAvatarPreview();
                feedbackElement.textContent = '';
                accountForm.querySelector('input[name="password"]').required = (mode === 'add');
                accountForm.querySelector('input[name="email"]').disabled = (mode === 'edit');
                
                if (mode === 'edit') {
                    modalTitle.textContent = '編輯帳號';
                    const user = allUsers.find(u => u.uid === uid);
                    if (!user) return;
                    // Populate form
                    Object.keys(user).forEach(key => {
                        const input = accountForm.querySelector(`[name="${key}"]`);
                        if (input) input.value = user[key];
                    });
                    if (user.avatarUrl) avatarPreview.src = user.avatarUrl;
                } else {
                    modalTitle.textContent = '新增帳號';
                }
                accountModal.classList.add('flex');
            }

            function closeAccountModal() {
                accountModal.classList.remove('flex');
            }

            async function handleAccountFormSubmit(e) {
                e.preventDefault();
                const formData = new FormData(accountForm);
                const data = Object.fromEntries(formData.entries());
                const isEditMode = !!data.uid;
                
                feedbackElement.textContent = '';
                if (data.password && data.password !== data.confirmPassword) {
                    feedbackElement.textContent = '錯誤：兩次輸入的密碼不一致。';
                    feedbackElement.classList.add('text-red-500');
                    return;
                }
                
                const submitButton = accountForm.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i> 儲存中...`;

                try {
                    if (isEditMode) {
                        // Update user
                        const userRef = doc(db, "users", data.uid);
                        const updateData = { name: data.name, role: data.role, title: data.title, phone: data.phone };
                        if (avatarInput.files[0]) {
                            const file = avatarInput.files[0];
                            const storageRef = ref(storage, `avatars/${data.uid}`);
                            await uploadBytes(storageRef, file);
                            updateData.avatarUrl = await getDownloadURL(storageRef);
                        }
                        await updateDoc(userRef, updateData);
                        // NOTE: Updating email/password requires re-authentication or a backend function.
                    } else {
                        // Create user
                        const userCredential = await createUserWithEmailAndPassword(auth, data.email, data.password);
                        const user = userCredential.user;
                        const userData = { uid: user.uid, email: data.email, role: data.role, name: data.name, title: data.title, phone: data.phone, createdAt: new Date() };
                        if (avatarInput.files[0]) {
                            const file = avatarInput.files[0];
                            const storageRef = ref(storage, `avatars/${user.uid}`);
                            await uploadBytes(storageRef, file);
                            userData.avatarUrl = await getDownloadURL(storageRef);
                        }
                        await setDoc(doc(db, "users", user.uid), userData);
                    }
                    
                    feedbackElement.textContent = `帳號已成功${isEditMode ? '更新' : '建立'}！`;
                    feedbackElement.classList.add('text-green-500');
                    setTimeout(() => {
                        closeAccountModal();
                        fetchAndRenderUsers();
                    }, 1500);

                } catch (error) {
                    console.error("Account form error:", error);
                    let message = '發生未知錯誤。';
                    if (error.code === 'auth/email-already-in-use') message = '錯誤：此電子郵件已被註冊。';
                    else if (error.code === 'auth/weak-password') message = '錯誤：密碼強度不足，至少需要6個字元。';
                    feedbackElement.textContent = message;
                    feedbackElement.classList.add('text-red-500');
                } finally {
                     submitButton.disabled = false;
                     submitButton.textContent = '儲存';
                }
            }

            function handleDeleteUser(uid, name) {
                showConfirmationModal(`確定要刪除 ${name} 的帳號嗎？`, async () => {
                    try {
                        await deleteDoc(doc(db, "users", uid));
                        // IMPORTANT: Deleting a user from Firebase Auth cannot be done from the client-side for security reasons,
                        // unless it's the currently signed-in user. This should be handled by a Cloud Function.
                        // The user will be removed from the list, but their auth entry might remain.
                        fetchAndRenderUsers();
                    } catch (error) {
                        console.error("Error deleting user: ", error);
                    }
                });
            }

            // --- Confirmation Modal ---
            function showConfirmationModal(text, onConfirm) {
                confirmationModal.querySelector('#confirm-text').textContent = text;
                confirmationModal.classList.add('flex');
                
                const actionBtn = confirmationModal.querySelector('#confirm-action-btn');
                const cancelBtn = confirmationModal.querySelector('#confirm-cancel-btn');

                const close = () => confirmationModal.classList.remove('flex');
                
                actionBtn.onclick = () => {
                    onConfirm();
                    close();
                };
                cancelBtn.onclick = close;
            }

            // --- Job Title Management ---
            async function loadJobTitles() {
                try {
                    const docSnap = await getDoc(settingsDocRef);
                    jobTitles = (docSnap.exists() && docSnap.data().titles) ? docSnap.data().titles : ['店長', '正職人員'];
                } catch (error) {
                    console.error("Error loading job titles:", error);
                    jobTitles = ['店長', '正職人員'];
                }
                renderAllTitles();
            }

            async function saveJobTitles() {
                await setDoc(settingsDocRef, { titles: jobTitles });
            }

            function renderTitleList() {
                if (!titleList) return;
                titleList.innerHTML = '';
                jobTitles.forEach((title, index) => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-md';
                    li.dataset.index = index;
                    li.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas fa-grip-vertical mr-3 text-gray-400 cursor-move drag-handle"></i>
                            <span class="title-text">${title}</span>
                        </div>
                        <div class="space-x-4">
                           <button class="text-gray-400 hover:text-blue-500 edit-title-btn"><i class="fas fa-edit"></i></button>
                           <button class="text-gray-400 hover:text-red-500 delete-title-btn"><i class="fas fa-trash"></i></button>
                        </div>`;
                    titleList.appendChild(li);
                });
            }

            function renderTitleDropdown() {
                const select = accountForm.querySelector('select[name="title"]');
                if (!select) return;
                select.innerHTML = '<option value="">-- 請選擇職稱 --</option>';
                jobTitles.forEach(title => {
                    select.innerHTML += `<option value="${title}">${title}</option>`;
                });
            }
            
            function renderAllTitles() {
                renderTitleList();
                renderTitleDropdown();
            }

            addTitleBtn.addEventListener('click', async () => {
                const newTitle = newTitleInput.value.trim();
                if (newTitle && !jobTitles.includes(newTitle)) {
                    jobTitles.push(newTitle);
                    newTitleInput.value = '';
                    renderAllTitles();
                    await saveJobTitles();
                }
            });

            titleList.addEventListener('click', async e => {
                const target = e.target;
                const li = target.closest('li');
                if (!li) return;
                const index = parseInt(li.dataset.index, 10);
                
                if (target.closest('.delete-title-btn')) {
                    jobTitles.splice(index, 1);
                    renderAllTitles();
                    await saveJobTitles();
                } else if (target.closest('.edit-title-btn')) {
                    const span = li.querySelector('.title-text');
                    const currentText = span.textContent;
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = currentText;
                    input.className = 'p-1 border rounded-md';
                    span.replaceWith(input);
                    input.focus();

                    const saveEdit = async () => {
                        const newText = input.value.trim();
                        if (newText && newText !== currentText) {
                            jobTitles[index] = newText;
                            await saveJobTitles();
                        }
                        renderAllTitles(); // Re-render the whole list to restore span
                    };

                    input.addEventListener('blur', saveEdit);
                    input.addEventListener('keydown', e => {
                        if (e.key === 'Enter') input.blur();
                        if (e.key === 'Escape') {
                            input.value = currentText;
                            input.blur();
                        }
                    });
                }
            });
            
            new Sortable(titleList, {
                handle: '.drag-handle', animation: 150, ghostClass: 'sortable-ghost',
                onEnd: async () => {
                    jobTitles = Array.from(titleList.querySelectorAll('li .title-text')).map(span => span.textContent);
                    renderTitleDropdown(); 
                    await saveJobTitles();
                }
            });
            
            // --- Avatar Preview ---
            const defaultAvatarSrc = 'https://placehold.co/100x100/e2e8f0/cbd5e0?text=頭像';
            function resetAvatarPreview() {
                avatarPreview.src = defaultAvatarSrc;
                avatarInput.value = '';
            }
            function handleAvatarChange() {
                const file = avatarInput.files[0];
                if (file) avatarPreview.src = URL.createObjectURL(file);
            }
        });
    </script>
</body>
</html>